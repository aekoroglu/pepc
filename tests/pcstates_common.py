#!/usr/bin/env python3
#
# -*- coding: utf-8 -*-
# vim: ts=4 sw=4 tw=100 et ai si
#
# Copyright (C) 2020-2022 Intel Corporation
# SPDX-License-Identifier: BSD-3-Clause
#
# Author: Niklas Neronin <niklas.neronin@intel.com>

"""Common functions for the 'CStates' and 'PStates' class tests."""

def get_fellows(params, cpuinfo, cpu=0):
    """
    Return a dict with keys being scopes and values being all fellow CPUs (CPUs sharing the same
    scope as a CPU) to the CPU 'cpu'. The dict is used when running tests with function calls that
    require a list of CPUs with the same scope as the CPU that we are changing the value of.

    The argument are as follows.
     * params - Various common parameters for running the tests.
     * cpuinfo - CPU information object generated by 'CPUInfo.CPUInfo()'.
     * cpu - the CPU whose fellows we return.
    """

    levels = cpuinfo.get_cpu_levels(cpu)

    fellows = {}
    fellows["global"] = params["cpus"]
    fellows["package"] = cpuinfo.package_to_cpus(levels["package"])
    fellows["die"] = cpuinfo.dies_to_cpus(dies=levels["die"], packages=levels["package"])
    # No fellows['node'], because there is currently no property with 'node' scope.
    fellows["core"] = cpuinfo.cores_to_cpus(cores=levels["core"], packages=levels["package"])
    fellows["CPU"] = cpu

    return fellows

def set_and_verify(pcobj, pname, val1, val2, fellows):
    """
    This function sets and verifies that the get value matches the set value for each CPU in
    fellows.

    The argument are as follows.
     * pcobj - 'CStates' or 'PStates' object.
     * pname - name of the propery.
     * val1 - the first value.
     * val2 - the second value.
     * fellows - CPUs that share the same 'pname' property scope as CPU 0.
    """

    pcobj.set_prop(pname, val1, fellows)
    pcobj.set_prop(pname, val2, fellows)

    for cpu, pinfo in pcobj.get_props((pname, ), fellows):
        if pinfo[pname][pname] != val2:
            assert False, f"Failed to update property '{pname}' for CPU {cpu}\nSet to '{val2}' " \
                          f"and received '{pinfo[pname][pname]}'."
